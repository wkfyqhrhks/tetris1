<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‚˜ë§Œì˜ ìš°ì£¼ í…ŒíŠ¸ë¦¬ìŠ¤</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    h1 { margin-bottom: 8px; font-size: 20px; }
    #container {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }
    canvas {
      background: #020617;
      border: 2px solid #4b5563;
      box-shadow: 0 0 16px rgba(0,0,0,0.7);
    }
    #ui {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 14px;
      min-width: 150px;
    }
    .panel {
      padding: 8px 10px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #374151;
    }
    label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    button {
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #3b82f6;
      color: white;
    }
    button:hover { filter: brightness(1.05); }
    button:active { filter: brightness(0.95); }
    #volume { width: 100%; }
    small { font-size: 11px; color: #9ca3af; }
  </style>
</head>
<body>

  <h1>ë‚˜ë§Œì˜ ìš°ì£¼ í…ŒíŠ¸ë¦¬ìŠ¤ ğŸŒŒ</h1>

  <div id="container">
    <canvas id="game" width="240" height="480"></canvas>

    <div id="ui">
      <div class="panel">
        <label>Score <span id="score">0</span></label>
        <label>Lines <span id="lines">0</span></label>
        <label>Level <span id="level">1</span></label>
      </div>

      <div class="panel">
        <button id="startBtn">Start / Restart</button>
      </div>

      <div class="panel">
        <button id="muteBtn">Mute</button>
        <label>Volume
          <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5">
        </label>
        <small>â€» Start ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ BGM ì¬ìƒ</small>
      </div>

      <div class="panel">
        <div>ì¡°ì‘ë²•</div>
        <small>
          â† â†’ : ì¢Œìš° ì´ë™<br>
          â†‘ : íšŒì „<br>
          â†“ : ë¹ ë¥´ê²Œ ë‚´ë¦¬ê¸°<br>
          Space : í•˜ë“œ ë“œë¡­
        </small>
      </div>
    </div>
  </div>

  <!-- BGM 2ê°œ -->
  <audio id="bgm1" src="í…ŒíŠ¸ë¦¬ìŠ¤bgm.mp3" loop></audio>
  <audio id="bgm2" src="í…ŒíŠ¸ë¦¬ìŠ¤bgm2.mp3" loop></audio>

  <script>
    // ========================
    // ê¸°ë³¸ ì„¤ì •
    // ========================
    const COLS = 10;
    const ROWS = 20;
    const BLOCK_SIZE = 24;

    const KEY = { LEFT: 37, UP: 38, RIGHT: 39, DOWN: 40, SPACE: 32 };
    const BASE_DROP_INTERVAL = 800;

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const scoreEl = document.getElementById('score');
    const linesEl = document.getElementById('lines');
    const levelEl = document.getElementById('level');
    const startBtn = document.getElementById('startBtn');
    const muteBtn = document.getElementById('muteBtn');
    const volumeSlider = document.getElementById('volume');

    // ========================
    // ë°°ê²½ ì´ë¯¸ì§€ (2ê°œ)
    // ========================
    const bgImages = [
      new Image(), // 0: background1
      new Image()  // 1: background2
    ];
    bgImages[0].src = 'background1.png';
    bgImages[1].src = 'background2.png';

    const bgLoaded = [false, false];
    bgImages.forEach((img, i) => {
      img.onload = () => { bgLoaded[i] = true; };
    });

    let currentBgIndex = 0;           // í˜„ì¬ ë°°ê²½ index
    const BG_CHANGE_LEVEL = 5;        // ì´ ë ˆë²¨ ì´ìƒë¶€í„° 2ë²ˆ ë°°ê²½ ì‚¬ìš©

    // ========================
    // BGM (2ê°œ)
    // ========================
    const bgmElements = [
      document.getElementById('bgm1'),
      document.getElementById('bgm2')
    ];
    let currentBgmIndex = 0;
    let isMuted = false;

    // ì´ˆê¸° ë³¼ë¥¨ ì…‹ì—…
    bgmElements.forEach(bgm => {
      bgm.volume = parseFloat(volumeSlider.value);
    });

    function getCurrentBgm() {
      return bgmElements[currentBgmIndex];
    }

    function playBgm() {
      if (isMuted) return;
      const bgm = getCurrentBgm();
      if (bgm.paused) {
        bgm.currentTime = 0;
        bgm.play().catch(() => {});
      }
    }

    function stopBgm() {
      bgmElements.forEach(bgm => {
        bgm.pause();
        bgm.currentTime = 0;
      });
    }

    function switchBgm(index) {
      if (index === currentBgmIndex) return;
      const wasPlaying = !getCurrentBgm().paused && !isMuted;
      stopBgm();
      currentBgmIndex = index;
      if (wasPlaying) playBgm();
    }

    muteBtn.addEventListener('click', () => {
      isMuted = !isMuted;
      bgmElements.forEach(bgm => {
        bgm.muted = isMuted;
      });
      muteBtn.textContent = isMuted ? 'Unmute' : 'Mute';
    });

    volumeSlider.addEventListener('input', () => {
      const v = parseFloat(volumeSlider.value);
      bgmElements.forEach(bgm => {
        bgm.volume = v;
      });
    });

    // ========================
    // ê²Œì„ ìƒíƒœ
    // ========================
    let board;
    let currentPiece;
    let score = 0;
    let lines = 0;
    let level = 1;

    let lastTime = 0;
    let dropCounter = 0;
    let dropInterval = BASE_DROP_INTERVAL;

    let animationId;
    let gameOverFlag = false;

    const TETROMINOS = [
      null,
      { matrix: [[1,1,1,1]], color: '#22d3ee' },          // I
      { matrix: [[1,1],[1,1]], color: '#eab308' },        // O
      { matrix: [[0,1,0],[1,1,1]], color: '#a855f7' },    // T
      { matrix: [[0,1,1],[1,1,0]], color: '#22c55e' },    // S
      { matrix: [[1,1,0],[0,1,1]], color: '#ef4444' },    // Z
      { matrix: [[1,0,0],[1,1,1]], color: '#3b82f6' },    // J
      { matrix: [[0,0,1],[1,1,1]], color: '#f97316' }     // L
    ];

    // ========================
    // ìœ í‹¸ í•¨ìˆ˜
    // ========================
    function createBoard() {
      return Array.from({ length: ROWS }, () => Array(COLS).fill(0));
    }

    function updateUI() {
      scoreEl.textContent = score;
      linesEl.textContent = lines;
      levelEl.textContent = level;
    }

    function getColor(type) {
      return TETROMINOS[type].color;
    }

    // ========================
    // ë Œë”ë§
    // ========================
    function drawCell(x, y, type) {
      ctx.save();
      ctx.globalAlpha = 0.9; // ì•½ê°„ ë°˜íˆ¬ëª…í•´ì„œ ë°°ê²½ì´ ë¹„ì¹˜ê²Œ
      ctx.fillStyle = getColor(type);
      ctx.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
      ctx.strokeStyle = '#020617';
      ctx.strokeRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
      ctx.restore();
    }

    function drawBoard() {
      // ë°°ê²½ ë¨¼ì €
      if (bgLoaded[currentBgIndex]) {
        const bg = bgImages[currentBgIndex];
        ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = '#020617';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // ê·¸ ìœ„ì— ê³ ì •ëœ ë¸”ë¡ë“¤
      for (let y = 0; y < ROWS; y++) {
        for (let x = 0;
